# Supervisor configuration for RunPod deployment
# Manages multiple services: Redis, Ollama, FastAPI app

[supervisord]
nodaemon=true
user=root
logfile=/workspace/logs/supervisord.log
pidfile=/workspace/logs/supervisord.pid

[program:redis]
command=redis-server --bind 0.0.0.0 --port 6379 --save 60 1000 --appendonly yes
directory=/workspace
autostart=true
autorestart=true
stderr_logfile=/workspace/logs/redis.err.log
stdout_logfile=/workspace/logs/redis.out.log
user=root

[program:ollama]
command=/usr/local/bin/ollama serve
directory=/workspace
autostart=true
autorestart=true
stderr_logfile=/workspace/logs/ollama.err.log
stdout_logfile=/workspace/logs/ollama.out.log
user=root
environment=OLLAMA_HOST="0.0.0.0:11434",CUDA_VISIBLE_DEVICES="0"

[program:ai-search-app]
command=python3 -m uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers 1 --log-level info
directory=/workspace
autostart=true
autorestart=true
stderr_logfile=/workspace/logs/app.err.log
stdout_logfile=/workspace/logs/app.out.log
user=root
environment=REDIS_URL="redis://localhost:6379",OLLAMA_HOST="http://localhost:11434"

[program:model-init]
command=/workspace/init-models.sh
directory=/workspace
autostart=true
autorestart=false
startsecs=0
stderr_logfile=/workspace/logs/model-init.err.log
stdout_logfile=/workspace/logs/model-init.out.log
user=root