# AI Search System - Deployment Makefile
# Streamlined commands for building and deploying

.PHONY: help build dev prod runpod clean logs health test

# Default target
help:
	@echo "AI Search System - Deployment Commands"
	@echo "======================================"
	@echo ""
	@echo "Development:"
	@echo "  make dev          - Start development environment"
	@echo "  make logs         - View application logs"
	@echo "  make shell        - Access application shell"
	@echo ""
	@echo "Production:"
	@echo "  make prod         - Start production deployment"
	@echo "  make build        - Build production images"
	@echo ""
	@echo "RunPod GPU Cloud:"
	@echo "  make runpod       - Start RunPod deployment"
	@echo "  make runpod-build - Build RunPod-optimized image"
	@echo ""
	@echo "Development Quality:"
	@echo "  make lint         - Run code linting checks"
	@echo "  make format       - Format code with black & isort"
	@echo "  make typecheck    - Run mypy type checking"
	@echo "  make pytest       - Run unit tests (CI-safe, no integration)"
	@echo "  make pytest-all   - Run all tests (including integration)"
	@echo "  make check-all    - Run all quality checks"
	@echo ""
	@echo "Maintenance:"
	@echo "  make health       - Check system health"
	@echo "  make test         - Run API tests"
	@echo "  make clean        - Clean up containers and volumes"
	@echo "  make models       - Download default models"
	@echo ""

# Development environment
dev:
	@echo "ğŸš€ Starting development environment..."
	docker-compose up --build

dev-detached:
	@echo "ğŸš€ Starting development environment (background)..."
	docker-compose up --build -d

# Production deployment
prod:
	@echo "ğŸ­ Starting production deployment..."
	docker-compose -f docker-compose.yml up --build -d

build:
	@echo "ğŸ”¨ Building production images..."
	docker-compose -f docker-compose.yml build --no-cache

# RunPod deployment
runpod:
	@echo "ğŸ® Starting RunPod deployment..."
	docker-compose -f docker-compose.runpod.yml up --build

runpod-build:
	@echo "ğŸ”¨ Building RunPod-optimized image..."
	docker-compose -f docker-compose.runpod.yml build --no-cache

# Maintenance commands
logs:
	@echo "ğŸ“‹ Viewing application logs..."
	docker-compose logs -f ai-search

health:
	@echo "ğŸ¥ Checking system health..."
	@curl -f http://localhost:8000/health || echo "âŒ Health check failed"
	@echo ""
	@curl -f http://localhost:8000/system/status || echo "âŒ System status failed"

test:
	@echo "ğŸ§ª Running API tests..."
	@curl -f http://localhost:8000/health/live || echo "âŒ Liveness check failed"
	@curl -f http://localhost:8000/health/ready || echo "âŒ Readiness check failed"
	@curl -f http://localhost:8000/api/v1/models/list || echo "âŒ Models API failed"

# Development quality checks
lint:
	@echo "ğŸ” Running code quality checks..."
	@cd .. && python3 -m black --check app/ || echo "âš ï¸ Code formatting issues found (non-blocking)"
	@cd .. && python3 -m isort --check-only app/ || echo "âš ï¸ Import sorting issues found (non-blocking)"
	@cd .. && python3 -m ruff check app/ --select E,W,F --ignore E501,F401,F841,W291 || echo "âš ï¸ Ruff linting issues found (non-blocking)"
	@cd .. && python3 -m flake8 app/ --max-line-length=100 --ignore=E501,W503,F401,F841,W291 || echo "âš ï¸ Flake8 linting issues found (non-blocking)"
	@echo "âœ… All linting checks completed"

format:
	@echo "ğŸ¨ Formatting code..."
	@cd .. && python3 -m black app/
	@cd .. && python3 -m isort app/
	@echo "âœ… Code formatted"

typecheck:
	@echo "ğŸ” Running type checking..."
	@cd .. && python3 -m mypy app/main.py app/api/ --ignore-missing-imports --no-strict-optional --allow-untyped-defs || echo "âš ï¸ Type checking issues found (non-blocking)"
	@echo "âœ… Type checking completed"

pytest:
	@echo "ğŸ§ª Running pytest..."
	@cd .. && python3 -m pytest tests/ -v --tb=short -m "not integration" --ignore=tests/integration/ || echo "âš ï¸ Some tests failed (non-blocking)"
	@echo "âœ… Test execution completed"

pytest-all:
	@echo "ğŸ§ª Running all tests (including integration)..."
	@cd .. && python3 -m pytest tests/ -v --tb=short
	@echo "âœ… All tests completed"

check-all: lint typecheck pytest
	@echo "âœ… All checks passed - ready for commit!"

shell:
	@echo "ğŸ’» Accessing application shell..."
	docker exec -it ai-search-system /bin/bash

models:
	@echo "ğŸ“¦ Downloading default models..."
	@curl -X POST "http://localhost:8000/api/v1/models/download" \
		-H "Content-Type: application/json" \
		-d '{"model_name": "phi3:mini"}' || echo "âŒ Model download failed"

clean:
	@echo "ğŸ§¹ Cleaning up containers and volumes..."
	docker-compose down -v
	docker system prune -f

clean-all:
	@echo "ğŸ§¹ Deep clean - removing all images and volumes..."
	docker-compose down -v --rmi all
	docker system prune -af

# Status monitoring
status:
	@echo "ğŸ“Š System Status:"
	@echo "=================="
	@docker ps --filter "name=ai-search" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
	@echo ""
	@echo "ğŸ”— Service URLs:"
	@echo "  API: http://localhost:8000"
	@echo "  Docs: http://localhost:8000/docs" 
	@echo "  Health: http://localhost:8000/health"
	@echo "  Ollama: http://localhost:11434"

# Environment setup
setup:
	@echo "âš™ï¸  Setting up environment..."
	@if [ ! -f .env ]; then \
		cp .env.example .env; \
		echo "ğŸ“ Created .env from template - please edit with your API keys"; \
	else \
		echo "âœ… .env file already exists"; \
	fi